<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Compliance Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        .framework-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .framework-card {
            background: white;
            border-radius: 10px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }
        
        .framework-card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        
        .framework-card h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        .framework-card p {
            font-size: 13px;
            color: #718096;
            margin-bottom: 16px;
            min-height: 40px;
        }
        
        .framework-stats {
            display: flex;
            gap: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }
        
        .stat {
            flex: 1;
        }
        
        .stat-label {
            font-size: 11px;
            color: #718096;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-top: 4px;
        }
        
        .card-actions {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        .empty-state p {
            font-size: 14px;
            color: #718096;
            margin-bottom: 24px;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #718096;
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 0;
            border-bottom: 2px solid #e1e8ed;
        }
        
        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #5a6c7d;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
            border-bottom: none;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-color: #e1e8ed;
            border-bottom-color: white;
            position: relative;
            bottom: -2px;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 0 10px 10px 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }
        
        .metric-card h3 {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
        }
        
        .progress-bar {
            width: 100%;
            height: 40px;
            background: #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        thead {
            background: #f7fafc;
        }
        
        th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tbody tr:hover {
            background: #fafbfc;
        }
        
        tbody tr.filtered-out {
            display: none;
        }
        
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }
        
        textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        select {
            background: white;
            cursor: pointer;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            font-size: 20px;
            color: #2d3748;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #718096;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: #2d3748;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2d3748;
            font-size: 13px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        @media print {
            .tabs, .action-buttons, .filter-section {
                display: none;
            }
            .tab-content {
                display: block !important;
                box-shadow: none;
            }
        }
        
        .chart-section {
            background: white;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .chart-section h3 {
            font-size: 16px;
            margin-bottom: 20px;
            color: #2d3748;
        }
        
        .hidden {
            display: none !important;
        }
        
        .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-label {
            font-weight: 600;
            color: #2d3748;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }
        
        .clear-filter-btn {
            padding: 8px 16px;
            background: #718096;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .active-filter-badge {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üõ°Ô∏è Enterprise Compliance Tracker</h1>
                <p>Multi-framework compliance management platform</p>
            </div>
            <button class="btn" id="addFrameworkBtn">‚ûï Add Framework</button>
        </div>

        <div id="frameworkListView" class="view active">
            <h2 style="margin-bottom: 20px; color: #2d3748;">Your Frameworks</h2>
            <div id="frameworkGrid" class="framework-grid"></div>
        </div>

        <div id="frameworkDetailView" class="view">
            <div class="breadcrumb">
                <a id="backToFrameworks">‚Üê Back to Frameworks</a>
                <span>/</span>
                <span id="currentFrameworkName"></span>
            </div>

            <div class="tabs" id="tabButtons">
                <button class="tab active" data-tab="dashboard">Dashboard</button>
                <button class="tab" data-tab="assessment">Assessment</button>
                <button class="tab" data-tab="export">Export</button>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <h3>Overall Compliance</h3>
                        <div class="metric-value" id="overallScore">0%</div>
                    </div>
                    <div class="metric-card" style="border-left-color: #22c55e;">
                        <h3>Implemented</h3>
                        <div class="metric-value" id="implementedCount">0</div>
                    </div>
                    <div class="metric-card" style="border-left-color: #eab308;">
                        <h3>Partial</h3>
                        <div class="metric-value" id="partialCount">0</div>
                    </div>
                    <div class="metric-card" style="border-left-color: #dc2626;">
                        <h3>Not Implemented</h3>
                        <div class="metric-value" id="notImplementedCount">0</div>
                    </div>
                </div>

                <div class="chart-section">
                    <h3>Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                    </div>
                </div>

                <div class="chart-section">
                    <h3>Summary by Category</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Total</th>
                                    <th>Assessed</th>
                                    <th>Compliance</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="assessment" class="tab-content">
                <div class="action-buttons">
                    <button class="btn" id="saveProgressBtn">üíæ Save Progress</button>
                    <button class="btn btn-primary" id="addControlBtn">‚ûï Add Control</button>
                    <button class="btn btn-secondary" id="importControlsBtn">üì• Import Controls</button>
                    <button class="btn btn-secondary" id="loadSampleBtn">üìã Load Sample</button>
                    <button class="btn btn-secondary" id="resetAssessmentBtn">üóëÔ∏è Clear All</button>
                </div>

                <div class="filter-section" id="filterSection">
                    <span class="filter-label">üîç Filters:</span>
                    
                    <select class="filter-select" id="filterStatus" onchange="applyFilters()">
                        <option value="">All Statuses</option>
                        <option value="implemented">‚úÖ Fully Implemented</option>
                        <option value="partial">‚ö†Ô∏è Partially Implemented</option>
                        <option value="not-implemented">‚ùå Not Implemented</option>
                        <option value="na">‚äó Not Applicable</option>
                        <option value="unassessed">üìù Not Assessed</option>
                    </select>

                    <select class="filter-select" id="filterRisk" onchange="applyFilters()">
                        <option value="">All Risk Levels</option>
                        <option value="critical">üî¥ Critical</option>
                        <option value="high">üü† High</option>
                        <option value="medium">üü° Medium</option>
                        <option value="low">üü¢ Low</option>
                    </select>

                    <select class="filter-select" id="filterCategory" onchange="applyFilters()">
                        <option value="">All Categories</option>
                    </select>

                    <select class="filter-select" id="filterPriority" onchange="applyFilters()">
                        <option value="">All Priorities</option>
                        <option value="immediate">Immediate (0-7 days)</option>
                        <option value="short">Short-term (1-30 days)</option>
                        <option value="medium">Medium-term (1-3 months)</option>
                        <option value="long">Long-term (3-12 months)</option>
                    </select>

                    <button class="clear-filter-btn" onclick="clearFilters()">Clear Filters</button>
                    
                    <span id="filterResultCount" class="active-filter-badge" style="display: none;"></span>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #22c55e;"></div>
                        <span>Fully Implemented (100%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #eab308;"></div>
                        <span>Partially Implemented (50%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc2626;"></div>
                        <span>Not Implemented (0%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9ca3af;"></div>
                        <span>Not Applicable (N/A)</span>
                    </div>
                </div>

                <div class="controls-table">
                    <table id="assessmentTable">
                        <thead>
                            <tr>
                                <th>Safeguard</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Implementation Status</th>
                                <th>Evidence/Notes</th>
                                <th>Risk Level</th>
                                <th>Priority</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                    <div id="noResults" class="no-results" style="display: none;">
                        <p><strong>No controls match the current filters.</strong></p>
                        <p>Try adjusting your filter selections.</p>
                    </div>
                </div>

                <div id="noAssessmentMsg" class="empty-state hidden">
                    <div class="empty-state-icon">üìä</div>
                    <h3>No Controls Yet</h3>
                    <p>Add controls to start your assessment</p>
                    <button class="btn btn-primary" id="addControlBtn2">‚ûï Add Control</button>
                </div>
            </div>

            <div id="export" class="tab-content">
                <h2 style="margin-bottom: 20px;">Export Options</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="exportCSVBtn">üìä Export CSV</button>
                    <button class="btn btn-secondary" id="exportJSONBtn">üìÑ Export JSON</button>
                    <button class="btn btn-secondary" id="printBtn">üñ®Ô∏è Print Report</button>
                </div>
                <div class="chart-container">
                    <h3>Export Instructions</h3>
                    <p style="margin-bottom: 12px;">You can export your assessment data in the following formats:</p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>CSV:</strong> Opens in Excel/Google Sheets for further analysis</li>
                        <li><strong>JSON:</strong> For backup or importing into other systems</li>
                        <li><strong>Print:</strong> Generate a PDF report using your browser's print dialog (Ctrl+P or Cmd+P, then "Save as PDF")</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="frameworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Framework</h2>
                <button class="close-btn" id="closeFrameworkModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Framework Name *</label>
                <input type="text" id="frameworkName" placeholder="e.g., CIS Controls v8">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="frameworkDesc" placeholder="Brief description"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelFrameworkModal">Cancel</button>
                <button class="btn btn-primary" id="saveFrameworkBtn">Add Framework</button>
            </div>
        </div>
    </div>

    <div id="controlModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="controlModalTitle">Add Control</h2>
                <button class="close-btn" id="closeControlModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Control ID *</label>
                <input type="text" id="controlId" placeholder="e.g., 1.1">
            </div>
            <div class="form-group">
                <label>Title *</label>
                <input type="text" id="controlTitle" placeholder="Control title">
            </div>
            <div class="form-group">
                <label>Category *</label>
                <input type="text" id="controlCategory" placeholder="e.g., Asset Management">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="controlDescription" placeholder="Detailed description"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelControlModal">Cancel</button>
                <button class="btn btn-primary" id="saveControlBtn">Save</button>
            </div>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Controls</h2>
                <button class="close-btn" id="closeImportModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Upload CSV or JSON</label>
                <input type="file" id="importFile" accept=".csv,.json">
            </div>
            <p style="font-size: 12px; color: #718096; margin-bottom: 20px;">
                <strong>CSV format:</strong><br>
                Required columns: CIS Safeguard (or ID), Title, category<br>
                Optional: Description, Implementation Status, Evidence/Notes, Risk Level, Priority
            </p>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelImportModal">Cancel</button>
                <button class="btn btn-primary" id="processImportBtn">Import</button>
            </div>
        </div>
    </div>

    <script>
        let frameworks = [];
        let currentFrameworkId = null;
        let editingControlId = null;
        
        function getCurrentFramework() {
            return frameworks.find(function(f) { return f.id === currentFrameworkId; });
        }
        
        function printReport() {
            try {
                console.log('=== PRINT REPORT START ===');
                console.log('printReport function called');
                console.log('Checking getCurrentFramework...');
                
                var framework = getCurrentFramework();
                console.log('Current framework:', framework);
                console.log('currentFrameworkId:', currentFrameworkId);
                
                if (!framework) {
                    console.error('No framework found! currentFrameworkId is:', currentFrameworkId);
                    alert('‚ö†Ô∏è No Framework Open - Please open a framework first, then try exporting.');
                    return;
                }
                
                console.log('Getting framework stats...');
                var stats = getFrameworkStats(framework);
                console.log('Stats:', stats);
            
            var categories = {};
            
            for (var i = 0; i < framework.controls.length; i++) {
                var ctrl = framework.controls[i];
                var assess = framework.assessments[ctrl.id] || {};
                
                if (!categories[ctrl.category]) {
                    categories[ctrl.category] = { total: 0, assessed: 0, score: 0 };
                }
                categories[ctrl.category].total++;
                
                if (assess.status) {
                    categories[ctrl.category].assessed++;
                    if (assess.status === 'implemented') {
                        categories[ctrl.category].score += 1;
                    } else if (assess.status === 'partial') {
                        categories[ctrl.category].score += 0.5;
                    }
                }
            }
            
            console.log('Building HTML report...');
            var reportHTML = '<!DOCTYPE html>\n<html>\n<head>\n<meta charset="UTF-8">\n<title>' + framework.name + ' - Compliance Report</title>\n</head>\n<body style="font-family: Arial, sans-serif; padding: 40px; line-height: 1.6; max-width: 1200px; margin: 0 auto;">\n';
            
            reportHTML += '<h1 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px;">' + framework.name + '</h1>\n';
            reportHTML += '<div style="color: #718096; margin-bottom: 30px;">Generated: ' + new Date().toLocaleString() + '<br>' + (framework.description || '') + '</div>\n';
            
            reportHTML += '<h2 style="color: #2d3748; margin-top: 30px;">Executive Summary</h2>\n';
            reportHTML += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0;">\n';
            reportHTML += '<div style="border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: #718096; text-transform: uppercase;">Overall Compliance</div><div style="font-size: 32px; font-weight: bold; color: #667eea; margin-top: 5px;">' + stats.compliance + '%</div></div>\n';
            reportHTML += '<div style="border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: #718096; text-transform: uppercase;">Total Controls</div><div style="font-size: 32px; font-weight: bold; color: #667eea; margin-top: 5px;">' + framework.controls.length + '</div></div>\n';
            reportHTML += '<div style="border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: #718096; text-transform: uppercase;">Assessed</div><div style="font-size: 32px; font-weight: bold; color: #667eea; margin-top: 5px;">' + stats.assessed + '</div></div>\n';
            reportHTML += '<div style="border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 12px; color: #718096; text-transform: uppercase;">Remaining</div><div style="font-size: 32px; font-weight: bold; color: #667eea; margin-top: 5px;">' + (framework.controls.length - stats.assessed) + '</div></div>\n';
            reportHTML += '</div>\n';
            
            reportHTML += '<h2 style="color: #2d3748; margin-top: 30px;">Summary by Category</h2>\n';
            reportHTML += '<table style="width: 100%; border-collapse: collapse; margin: 20px 0;"><thead><tr>';
            reportHTML += '<th style="background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Category</th>';
            reportHTML += '<th style="background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Total Controls</th>';
            reportHTML += '<th style="background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Assessed</th>';
            reportHTML += '<th style="background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Compliance</th>';
            reportHTML += '</tr></thead><tbody>\n';
            
            for (var cat in categories) {
                var c = categories[cat];
                var compliance = c.total > 0 ? Math.round((c.score / c.total) * 100) : 0;
                reportHTML += '<tr><td style="padding: 10px; border-bottom: 1px solid #f0f0f0;">' + cat + '</td>';
                reportHTML += '<td style="padding: 10px; border-bottom: 1px solid #f0f0f0;">' + c.total + '</td>';
                reportHTML += '<td style="padding: 10px; border-bottom: 1px solid #f0f0f0;">' + c.assessed + '</td>';
                reportHTML += '<td style="padding: 10px; border-bottom: 1px solid #f0f0f0;"><strong>' + compliance + '%</strong></td></tr>\n';
            }
            
            reportHTML += '</tbody></table>\n';
            reportHTML += '<h2 style="color: #2d3748; margin-top: 30px;">Detailed Assessment</h2>\n';
            reportHTML += '<table style="width: 100%; border-collapse: collapse; margin: 20px 0;"><thead><tr>';
            reportHTML += '<th style="background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">ID</th>';
            reportHTML += '<th style="background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Title</th>';
            reportHTML += '<th style="background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Category</th>';
            reportHTML += '<th style="background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Status</th>';
            reportHTML += '<th style="background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Risk</th>';
            reportHTML += '<th style="background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Notes</th>';
            reportHTML += '</tr></thead><tbody>\n';
            
            for (var i = 0; i < framework.controls.length; i++) {
                var ctrl = framework.controls[i];
                var assess = framework.assessments[ctrl.id] || {};
                var statusStyle = '';
                var statusText = 'Not Assessed';
                
                if (assess.status === 'implemented') {
                    statusStyle = 'color: #22c55e; font-weight: bold;';
                    statusText = '‚úì Implemented';
                } else if (assess.status === 'partial') {
                    statusStyle = 'color: #eab308; font-weight: bold;';
                    statusText = '‚ö† Partial';
                } else if (assess.status === 'not-implemented') {
                    statusStyle = 'color: #dc2626; font-weight: bold;';
                    statusText = '‚úó Not Implemented';
                } else if (assess.status === 'na') {
                    statusText = 'N/A';
                }
                
                var riskStyle = '';
                var riskText = assess.risk || '-';
                if (assess.risk === 'critical') riskStyle = 'color: #dc2626;';
                else if (assess.risk === 'high') riskStyle = 'color: #f59e0b;';
                else if (assess.risk === 'medium') riskStyle = 'color: #eab308;';
                else if (assess.risk === 'low') riskStyle = 'color: #22c55e;';
                
                reportHTML += '<tr><td style="padding: 10px; border-bottom: 1px solid #f0f0f0;"><strong>' + ctrl.id + '</strong></td>';
                reportHTML += '<td style="padding: 10px; border-bottom: 1px solid #f0f0f0;">' + ctrl.title + '</td>';
                reportHTML += '<td style="padding: 10px; border-bottom: 1px solid #f0f0f0;">' + ctrl.category + '</td>';
                reportHTML += '<td style="padding: 10px; border-bottom: 1px solid #f0f0f0; ' + statusStyle + '">' + statusText + '</td>';
                reportHTML += '<td style="padding: 10px; border-bottom: 1px solid #f0f0f0; ' + riskStyle + '">' + riskText + '</td>';
                reportHTML += '<td style="padding: 10px; border-bottom: 1px solid #f0f0f0;">' + (assess.notes || '-') + '</td></tr>\n';
            }
            
            reportHTML += '</tbody></table>\n</body>\n</html>';
            
            console.log('Calling showDownloadModal...');
            showDownloadModal('Print Report - Save as HTML', reportHTML, framework.name.replace(/[^a-z0-9]/gi, '_') + '_report_' + new Date().toISOString().split('T')[0] + '.html', 'text/html');
            console.log('printReport function completed');
            
            } catch (error) {
                console.error('CRITICAL ERROR in printReport:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                alert('Error in printReport: ' + error.message);
            }
        }

        function init() {
            loadFromStorage();
            renderFrameworkList();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Framework buttons
            var addFrameworkBtn = document.getElementById('addFrameworkBtn');
            if (addFrameworkBtn) addFrameworkBtn.addEventListener('click', openFrameworkModal);
            
            var backToFrameworks = document.getElementById('backToFrameworks');
            if (backToFrameworks) backToFrameworks.addEventListener('click', showFrameworkList);
            
            // Tab buttons
            var tabButtons = document.querySelectorAll('#tabButtons .tab');
            tabButtons.forEach(function(tab) {
                tab.addEventListener('click', function() { switchTab(this.dataset.tab); });
            });
            
            // Control buttons
            var addControlBtn = document.getElementById('addControlBtn');
            if (addControlBtn) addControlBtn.addEventListener('click', function() { openControlModal(); });
            
            var addControlBtn2 = document.getElementById('addControlBtn2');
            if (addControlBtn2) addControlBtn2.addEventListener('click', function() { openControlModal(); });
            
            var importControlsBtn = document.getElementById('importControlsBtn');
            if (importControlsBtn) importControlsBtn.addEventListener('click', openImportModal);
            
            var loadSampleBtn = document.getElementById('loadSampleBtn');
            if (loadSampleBtn) loadSampleBtn.addEventListener('click', loadSampleData);
            
            var saveProgressBtn = document.getElementById('saveProgressBtn');
            if (saveProgressBtn) saveProgressBtn.addEventListener('click', saveAssessment);
            
            var resetAssessmentBtn = document.getElementById('resetAssessmentBtn');
            if (resetAssessmentBtn) resetAssessmentBtn.addEventListener('click', resetAssessment);
            
            // Export buttons
            var exportCSVBtn = document.getElementById('exportCSVBtn');
            if (exportCSVBtn) exportCSVBtn.addEventListener('click', exportToCSV);
            
            var exportJSONBtn = document.getElementById('exportJSONBtn');
            if (exportJSONBtn) exportJSONBtn.addEventListener('click', exportToJSON);
            
            var printBtn = document.getElementById('printBtn');
            if (printBtn) {
                printBtn.addEventListener('click', function() {
                    console.log('Print button clicked');
                    console.log('printReport function exists?', typeof printReport);
                    console.log('printReport toString:', printReport.toString().substring(0, 200));
                    console.log('getCurrentFramework function exists?', typeof getCurrentFramework);
                    console.log('About to call printReport()...');
                    try {
                        var result = printReport();
                        console.log('printReport() returned:', result);
                    } catch (error) {
                        console.error('Error in printReport:', error);
                        console.error('Error stack:', error.stack);
                        alert('Error generating report: ' + error.message);
                    }
                    console.log('After printReport() call');
                });
            } else {
                console.error('Print button not found!');
            }
            
            // Modal close buttons
            var closeFrameworkModal = document.getElementById('closeFrameworkModal');
            if (closeFrameworkModal) closeFrameworkModal.addEventListener('click', closeFrameworkModalHandler);
            
            var cancelFrameworkModal = document.getElementById('cancelFrameworkModal');
            if (cancelFrameworkModal) cancelFrameworkModal.addEventListener('click', closeFrameworkModalHandler);
            
            var saveFrameworkBtn = document.getElementById('saveFrameworkBtn');
            if (saveFrameworkBtn) saveFrameworkBtn.addEventListener('click', saveFramework);
            
            var closeControlModal = document.getElementById('closeControlModal');
            if (closeControlModal) closeControlModal.addEventListener('click', closeControlModalHandler);
            
            var cancelControlModal = document.getElementById('cancelControlModal');
            if (cancelControlModal) cancelControlModal.addEventListener('click', closeControlModalHandler);
            
            var saveControlBtn = document.getElementById('saveControlBtn');
            if (saveControlBtn) saveControlBtn.addEventListener('click', saveControl);
            
            var closeImportModal = document.getElementById('closeImportModal');
            if (closeImportModal) closeImportModal.addEventListener('click', closeImportModalHandler);
            
            var cancelImportModal = document.getElementById('cancelImportModal');
            if (cancelImportModal) cancelImportModal.addEventListener('click', closeImportModalHandler);
            
            var processImportBtn = document.getElementById('processImportBtn');
            if (processImportBtn) processImportBtn.addEventListener('click', processImport);
            
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('show');
                }
            });
        }

        function loadFromStorage() {
            var saved = localStorage.getItem('complianceFrameworks');
            if (saved) {
                frameworks = JSON.parse(saved);
            }
        }

        function saveToStorage() {
            localStorage.setItem('complianceFrameworks', JSON.stringify(frameworks));
        }

        function openFrameworkModal() {
            document.getElementById('frameworkName').value = '';
            document.getElementById('frameworkDesc').value = '';
            document.getElementById('frameworkModal').classList.add('show');
        }

        function closeFrameworkModal() {
            document.getElementById('frameworkModal').classList.remove('show');
        }
        
        function closeFrameworkModalHandler() {
            closeFrameworkModal();
        }

        function saveFramework() {
            var name = document.getElementById('frameworkName').value.trim();
            var desc = document.getElementById('frameworkDesc').value.trim();
            
            if (!name) {
                alert('Please enter a framework name');
                return;
            }
            
            var framework = {
                id: Date.now().toString(),
                name: name,
                description: desc,
                controls: [],
                assessments: {}
            };
            
            frameworks.push(framework);
            saveToStorage();
            renderFrameworkList();
            closeFrameworkModal();
        }

        function renderFrameworkList() {
            var grid = document.getElementById('frameworkGrid');
            
            if (frameworks.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üè¢</div><h3>No Frameworks Yet</h3><p>Get started by adding your first compliance framework</p><button class="btn btn-primary" onclick="openFrameworkModal()">‚ûï Add Framework</button></div>';
                return;
            }
            
            grid.innerHTML = '';
            for (var i = 0; i < frameworks.length; i++) {
                var fw = frameworks[i];
                var stats = getFrameworkStats(fw);
                
                var card = document.createElement('div');
                card.className = 'framework-card';
                card.style.cursor = 'default';
                
                card.innerHTML = '<h3>' + fw.name + '</h3><p>' + (fw.description || 'No description') + '</p><div class="framework-stats"><div class="stat"><div class="stat-label">Controls</div><div class="stat-value">' + fw.controls.length + '</div></div><div class="stat"><div class="stat-label">Compliance</div><div class="stat-value">' + stats.compliance + '%</div></div></div><div class="card-actions"></div>';
                
                var openBtn = document.createElement('button');
                openBtn.className = 'btn btn-small btn-primary';
                openBtn.textContent = 'üìÇ Open';
                openBtn.onclick = (function(id) {
                    return function(e) {
                        e.stopPropagation();
                        openFramework(id);
                    };
                })(fw.id);
                
                var deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-small btn-danger';
                deleteBtn.textContent = 'üóëÔ∏è Delete';
                deleteBtn.style.marginLeft = 'auto';
                deleteBtn.setAttribute('data-framework-id', fw.id);
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var fwId = this.getAttribute('data-framework-id');
                    deleteFramework(fwId);
                });
                
                var actions = card.querySelector('.card-actions');
                actions.appendChild(openBtn);
                actions.appendChild(deleteBtn);
                grid.appendChild(card);
            }
        }

        function getFrameworkStats(framework) {
            var total = 0;
            var assessed = 0;
            
            for (var i = 0; i < framework.controls.length; i++) {
                var ctrl = framework.controls[i];
                var assess = framework.assessments[ctrl.id];
                if (assess && assess.status) {
                    assessed++;
                    if (assess.status === 'implemented') total += 1;
                    else if (assess.status === 'partial') total += 0.5;
                }
            }
            
            var compliance = framework.controls.length > 0 ? Math.round((total / framework.controls.length) * 100) : 0;
            
            return { compliance: compliance, assessed: assessed };
        }

        function deleteFramework(id) {
            var framework = frameworks.find(function(f) { return f.id === id; });
            if (confirm('Delete "' + framework.name + '"? This will permanently delete all controls and assessment data.')) {
                frameworks = frameworks.filter(function(f) { return f.id !== id; });
                saveToStorage();
                renderFrameworkList();
            }
        }

        function openFramework(id) {
            currentFrameworkId = id;
            var framework = getCurrentFramework();
            
            document.getElementById('currentFrameworkName').textContent = framework.name;
            document.getElementById('frameworkListView').classList.remove('active');
            document.getElementById('frameworkDetailView').classList.add('active');
            
            renderAssessment();
            updateDashboard();
        }

        function showFrameworkList() {
            currentFrameworkId = null;
            document.getElementById('frameworkListView').classList.add('active');
            document.getElementById('frameworkDetailView').classList.remove('active');
        }

        function openControlModal(controlId) {
            editingControlId = controlId || null;
            
            if (controlId) {
                var framework = getCurrentFramework();
                var control = framework.controls.find(function(c) { return c.id === controlId; });
                document.getElementById('controlModalTitle').textContent = 'Edit Control';
                document.getElementById('controlId').value = control.id;
                document.getElementById('controlTitle').value = control.title;
                document.getElementById('controlCategory').value = control.category;
                document.getElementById('controlDescription').value = control.description || '';
            } else {
                document.getElementById('controlModalTitle').textContent = 'Add Control';
                document.getElementById('controlId').value = '';
                document.getElementById('controlTitle').value = '';
                document.getElementById('controlCategory').value = '';
                document.getElementById('controlDescription').value = '';
            }
            
            document.getElementById('controlModal').classList.add('show');
        }

        function closeControlModal() {
            document.getElementById('controlModal').classList.remove('show');
            editingControlId = null;
        }
        
        function closeControlModalHandler() {
            closeControlModal();
        }

        function saveControl() {
            var id = document.getElementById('controlId').value.trim();
            var title = document.getElementById('controlTitle').value.trim();
            var category = document.getElementById('controlCategory').value.trim();
            var description = document.getElementById('controlDescription').value.trim();
            
            if (!id || !title || !category) {
                alert('Please fill in all required fields');
                return;
            }
            
            var framework = getCurrentFramework();
            
            if (editingControlId) {
                var control = framework.controls.find(function(c) { return c.id === editingControlId; });
                if (control) {
                    control.id = id;
                    control.title = title;
                    control.category = category;
                    control.description = description;
                }
            } else {
                if (framework.controls.some(function(c) { return c.id === id; })) {
                    alert('A control with this ID already exists');
                    return;
                }
                framework.controls.push({ id: id, title: title, category: category, description: description });
            }
            
            saveToStorage();
            renderAssessment();
            updateDashboard();
            closeControlModal();
        }

        function renderAssessment() {
            var framework = getCurrentFramework();
            var tbody = document.getElementById('tableBody');
            var table = document.getElementById('assessmentTable');
            var emptyMsg = document.getElementById('noAssessmentMsg');
            var filterSection = document.getElementById('filterSection');
            
            if (framework.controls.length === 0) {
                table.style.display = 'none';
                emptyMsg.classList.remove('hidden');
                if (filterSection) filterSection.style.display = 'none';
                document.querySelector('.legend').style.display = 'none';
                return;
            }
            
            table.style.display = 'table';
            emptyMsg.classList.add('hidden');
            if (filterSection) filterSection.style.display = 'flex';
            document.querySelector('.legend').style.display = 'flex';
            
            var categoryFilter = document.getElementById('filterCategory');
            var uniqueCategories = [];
            for (var i = 0; i < framework.controls.length; i++) {
                if (uniqueCategories.indexOf(framework.controls[i].category) === -1) {
                    uniqueCategories.push(framework.controls[i].category);
                }
            }
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            uniqueCategories.forEach(function(cat) {
                var option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            
            tbody.innerHTML = '';
            
            framework.controls.forEach(function(control, index) {
                var assess = framework.assessments[control.id] || {};
                
                var row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${control.id}</strong></td>
                    <td>${control.title}</td>
                    <td style="font-size: 11px; color: #718096;">${control.category}</td>
                    <td>
                        <select onchange="updateAssessmentStatus(${index}, this.value)">
                            <option value="">-- Select --</option>
                            <option value="implemented"${assess.status === 'implemented' ? ' selected' : ''}>‚úÖ Fully Implemented</option>
                            <option value="partial"${assess.status === 'partial' ? ' selected' : ''}>‚ö†Ô∏è Partially Implemented</option>
                            <option value="not-implemented"${assess.status === 'not-implemented' ? ' selected' : ''}>‚ùå Not Implemented</option>
                            <option value="na"${assess.status === 'na' ? ' selected' : ''}>‚äó Not Applicable</option>
                        </select>
                    </td>
                    <td>
                        <textarea placeholder="Enter evidence and notes..." onchange="updateAssessmentNotes(${index}, this.value)">${assess.notes || ''}</textarea>
                    </td>
                    <td>
                        <select onchange="updateAssessmentRisk(${index}, this.value)">
                            <option value="">-- Select --</option>
                            <option value="critical"${assess.risk === 'critical' ? ' selected' : ''}>üî¥ Critical</option>
                            <option value="high"${assess.risk === 'high' ? ' selected' : ''}>üü† High</option>
                            <option value="medium"${assess.risk === 'medium' ? ' selected' : ''}>üü° Medium</option>
                            <option value="low"${assess.risk === 'low' ? ' selected' : ''}>üü¢ Low</option>
                            <option value="na"${assess.risk === 'na' ? ' selected' : ''}>N/A</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateAssessmentPriority(${index}, this.value)">
                            <option value="">-- Select --</option>
                            <option value="immediate"${assess.priority === 'immediate' ? ' selected' : ''}>Immediate (0-7 days)</option>
                            <option value="short"${assess.priority === 'short' ? ' selected' : ''}>Short-term (1-30 days)</option>
                            <option value="medium"${assess.priority === 'medium' ? ' selected' : ''}>Medium-term (1-3 months)</option>
                            <option value="long"${assess.priority === 'long' ? ' selected' : ''}>Long-term (3-12 months)</option>
                        </select>
                    </td>
                `;
            });
        }
        
        function updateAssessmentStatus(index, status) {
            var framework = getCurrentFramework();
            var control = framework.controls[index];
            if (!framework.assessments[control.id]) {
                framework.assessments[control.id] = {};
            }
            framework.assessments[control.id].status = status;
            saveToStorage();
            updateDashboard();
        }
        
        function updateAssessmentNotes(index, notes) {
            var framework = getCurrentFramework();
            var control = framework.controls[index];
            if (!framework.assessments[control.id]) {
                framework.assessments[control.id] = {};
            }
            framework.assessments[control.id].notes = notes;
            saveToStorage();
        }
        
        function updateAssessmentRisk(index, risk) {
            var framework = getCurrentFramework();
            var control = framework.controls[index];
            if (!framework.assessments[control.id]) {
                framework.assessments[control.id] = {};
            }
            framework.assessments[control.id].risk = risk;
            saveToStorage();
            updateDashboard();
        }
        
        function updateAssessmentPriority(index, priority) {
            var framework = getCurrentFramework();
            var control = framework.controls[index];
            if (!framework.assessments[control.id]) {
                framework.assessments[control.id] = {};
            }
            framework.assessments[control.id].priority = priority;
            saveToStorage();
        }

        function saveAssessment() {
            saveToStorage();
            alert('Assessment saved successfully!');
        }

        function resetAssessment() {
            if (confirm('This will clear all assessment data. Are you sure?')) {
                var framework = getCurrentFramework();
                framework.assessments = {};
                saveToStorage();
                renderAssessment();
                updateDashboard();
                alert('Assessment data cleared!');
            }
        }
        
        function applyFilters() {
            var statusFilter = document.getElementById('filterStatus').value;
            var riskFilter = document.getElementById('filterRisk').value;
            var categoryFilter = document.getElementById('filterCategory').value;
            var priorityFilter = document.getElementById('filterPriority').value;
            
            var framework = getCurrentFramework();
            var tbody = document.getElementById('tableBody');
            var rows = tbody.getElementsByTagName('tr');
            var visibleCount = 0;
            
            for (var i = 0; i < rows.length; i++) {
                var control = framework.controls[i];
                var assess = framework.assessments[control.id] || {};
                var show = true;
                
                if (statusFilter) {
                    if (statusFilter === 'unassessed') {
                        show = show && (!assess.status || assess.status === '');
                    } else {
                        show = show && (assess.status === statusFilter);
                    }
                }
                
                if (riskFilter) {
                    show = show && (assess.risk === riskFilter);
                }
                
                if (categoryFilter) {
                    show = show && (control.category === categoryFilter);
                }
                
                if (priorityFilter) {
                    show = show && (assess.priority === priorityFilter);
                }
                
                if (show) {
                    rows[i].classList.remove('filtered-out');
                    visibleCount++;
                } else {
                    rows[i].classList.add('filtered-out');
                }
            }
            
            var resultBadge = document.getElementById('filterResultCount');
            var hasActiveFilters = statusFilter || riskFilter || categoryFilter || priorityFilter;
            
            if (hasActiveFilters) {
                resultBadge.style.display = 'inline-block';
                resultBadge.textContent = visibleCount + ' of ' + rows.length + ' controls';
            } else {
                resultBadge.style.display = 'none';
            }
            
            var noResults = document.getElementById('noResults');
            if (visibleCount === 0 && hasActiveFilters) {
                noResults.style.display = 'block';
            } else {
                noResults.style.display = 'none';
            }
        }
        
        function clearFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterRisk').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterPriority').value = '';
            
            var tbody = document.getElementById('tableBody');
            var rows = tbody.getElementsByTagName('tr');
            for (var i = 0; i < rows.length; i++) {
                rows[i].classList.remove('filtered-out');
            }
            
            document.getElementById('filterResultCount').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
        }

        function updateDashboard() {
            var framework = getCurrentFramework();
            if (!framework) return;
            
            var implemented = 0, partial = 0, notImplemented = 0;
            var total = 0;
            var categories = {};
            
            for (var i = 0; i < framework.controls.length; i++) {
                var ctrl = framework.controls[i];
                var assess = framework.assessments[ctrl.id] || {};
                
                if (!categories[ctrl.category]) {
                    categories[ctrl.category] = { total: 0, assessed: 0, score: 0 };
                }
                categories[ctrl.category].total++;
                
                if (assess.status) {
                    categories[ctrl.category].assessed++;
                    
                    if (assess.status === 'implemented') {
                        implemented++;
                        total += 1;
                        categories[ctrl.category].score += 1;
                    } else if (assess.status === 'partial') {
                        partial++;
                        total += 0.5;
                        categories[ctrl.category].score += 0.5;
                    } else if (assess.status === 'not-implemented') {
                        notImplemented++;
                    }
                }
            }
            
            var score = framework.controls.length > 0 ? Math.round((total / framework.controls.length) * 100) : 0;
            
            document.getElementById('overallScore').textContent = score + '%';
            document.getElementById('implementedCount').textContent = implemented;
            document.getElementById('partialCount').textContent = partial;
            document.getElementById('notImplementedCount').textContent = notImplemented;
            document.getElementById('progressBar').style.width = score + '%';
            document.getElementById('progressBar').textContent = score + '%';
            
            var summaryHtml = '';
            for (var cat in categories) {
                var stats = categories[cat];
                var compliance = stats.total > 0 ? Math.round((stats.score / stats.total) * 100) : 0;
                summaryHtml += '<tr><td>' + cat + '</td><td>' + stats.total + '</td><td>' + stats.assessed + '</td><td><strong>' + compliance + '%</strong></td></tr>';
            }
            document.getElementById('summaryTable').innerHTML = summaryHtml;
        }

        function switchTab(tabName) {
            var tabs = document.querySelectorAll('.tab');
            var contents = document.querySelectorAll('.tab-content');
            
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            
            document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function openImportModal() {
            document.getElementById('importFile').value = '';
            document.getElementById('importModal').classList.add('show');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }
        
        function closeImportModalHandler() {
            closeImportModal();
        }

        function processImport() {
            console.log('Starting import');
            var fileInput = document.getElementById('importFile');
            var file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var controls = [];
                    var assessments = {};
                    
                    if (file.name.endsWith('.json')) {
                        var data = JSON.parse(e.target.result);
                        controls = Array.isArray(data) ? data : (data.controls || []);
                    } else if (file.name.endsWith('.csv')) {
                        var text = e.target.result;
                        var rows = [];
                        var currentRow = [];
                        var currentCell = '';
                        var inQuotes = false;
                        
                        for (var i = 0; i < text.length; i++) {
                            var char = text[i];
                            var nextChar = i + 1 < text.length ? text[i + 1] : '';
                            
                            if (char === '"') {
                                if (inQuotes && nextChar === '"') {
                                    currentCell += '"';
                                    i++;
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === ',' && !inQuotes) {
                                currentRow.push(currentCell);
                                currentCell = '';
                            } else if ((char === '\n' || char === '\r') && !inQuotes) {
                                if (char === '\r' && nextChar === '\n') i++;
                                if (currentCell || currentRow.length > 0) {
                                    currentRow.push(currentCell);
                                    rows.push(currentRow);
                                    currentRow = [];
                                    currentCell = '';
                                }
                            } else {
                                currentCell += char;
                            }
                        }
                        
                        if (currentCell || currentRow.length > 0) {
                            currentRow.push(currentCell);
                            rows.push(currentRow);
                        }
                        
                        if (rows.length === 0) {
                            alert('No data found in CSV');
                            return;
                        }
                        
                        var headers = rows[0].map(function(h) { return h.trim(); });
                        var colSafeguard = -1, colTitle = -1, colCategory = -1, colDescription = -1;
                        var colStatus = -1, colNotes = -1, colRisk = -1, colPriority = -1;
                        
                        for (var i = 0; i < headers.length; i++) {
                            var h = headers[i].toLowerCase();
                            if (h.includes('safeguard') || h === 'id') colSafeguard = i;
                            else if (h === 'title') colTitle = i;
                            else if (h === 'category') colCategory = i;
                            else if (h === 'description') colDescription = i;
                            else if (h.includes('implementation status') || h === 'status') colStatus = i;
                            else if (h.includes('evidence') && h.includes('notes')) colNotes = i;
                            else if (h.includes('risk level') || h === 'risk') colRisk = i;
                            else if (h === 'priority') colPriority = i;
                        }
                        
                        for (var i = 1; i < rows.length; i++) {
                            var row = rows[i];
                            if (row.length === 0 || row.every(function(cell) { return !cell.trim(); })) continue;
                            
                            var id = colSafeguard >= 0 && row[colSafeguard] ? row[colSafeguard].trim() : '';
                            var title = colTitle >= 0 && row[colTitle] ? row[colTitle].trim() : '';
                            var category = colCategory >= 0 && row[colCategory] ? row[colCategory].trim() : '';
                            var description = colDescription >= 0 && row[colDescription] ? row[colDescription].trim() : '';
                            var status = colStatus >= 0 && row[colStatus] ? row[colStatus].trim() : '';
                            var notes = colNotes >= 0 && row[colNotes] ? row[colNotes].trim() : '';
                            var risk = colRisk >= 0 && row[colRisk] ? row[colRisk].trim() : '';
                            var priority = colPriority >= 0 && row[colPriority] ? row[colPriority].trim() : '';
                            
                            if (id && title && category) {
                                controls.push({ id: id, title: title, category: category, description: description });
                                
                                var normalizedStatus = '';
                                if (status) {
                                    var s = status.toLowerCase().trim();
                                    if (s.includes('fully')) normalizedStatus = 'implemented';
                                    else if (s.includes('partial')) normalizedStatus = 'partial';
                                    else if (s.includes('not implemented')) normalizedStatus = 'not-implemented';
                                    else if (s.includes('not applicable') || s === 'na' || s === 'n/a') normalizedStatus = 'na';
                                    else if (s === 'implemented') normalizedStatus = 'implemented';
                                }
                                
                                var normalizedRisk = '';
                                if (risk) {
                                    var r = risk.toLowerCase().trim();
                                    if (r.includes('critical')) normalizedRisk = 'critical';
                                    else if (r.includes('high')) normalizedRisk = 'high';
                                    else if (r.includes('medium')) normalizedRisk = 'medium';
                                    else if (r.includes('low')) normalizedRisk = 'low';
                                    else if (r === 'na' || r === 'n/a') normalizedRisk = 'na';
                                }
                                
                                var normalizedPriority = '';
                                if (priority) {
                                    var p = priority.toLowerCase().trim();
                                    if (p.includes('immediate') || p.includes('0-7')) normalizedPriority = 'immediate';
                                    else if (p.includes('short') || p.includes('1-30')) normalizedPriority = 'short';
                                    else if (p.includes('medium') || p.includes('1-3 month')) normalizedPriority = 'medium';
                                    else if (p.includes('long') || p.includes('3-12')) normalizedPriority = 'long';
                                }
                                
                                if (normalizedStatus || notes || normalizedRisk || normalizedPriority) {
                                    assessments[id] = {};
                                    if (normalizedStatus) assessments[id].status = normalizedStatus;
                                    if (notes) assessments[id].notes = notes;
                                    if (normalizedRisk) assessments[id].risk = normalizedRisk;
                                    if (normalizedPriority) assessments[id].priority = normalizedPriority;
                                }
                            }
                        }
                    }
                    
                    if (controls.length === 0) {
                        alert('No valid controls found');
                        return;
                    }
                    
                    var framework = getCurrentFramework();
                    framework.controls = framework.controls.concat(controls);
                    for (var id in assessments) {
                        framework.assessments[id] = assessments[id];
                    }
                    
                    saveToStorage();
                    renderAssessment();
                    updateDashboard();
                    closeImportModal();
                    
                    var msg = '‚úì Imported ' + controls.length + ' control(s)!';
                    if (Object.keys(assessments).length > 0) {
                        msg += '\n‚úì Loaded assessment data for ' + Object.keys(assessments).length + ' control(s)!';
                    }
                    alert(msg);
                } catch (err) {
                    console.error('Import error:', err);
                    alert('Error importing file: ' + err.message);
                }
            };
            
            reader.readAsText(file);
        }

        function exportToCSV() {
            var framework = getCurrentFramework();
            if (!framework) {
                alert('‚ö†Ô∏è No Framework Open\n\nPlease follow these steps:\n\n1. Go back to the main page\n2. Create a framework (click "‚ûï Add Framework")\n3. Open the framework (click "üìÇ Open")\n4. Add controls to assess\n5. Then you can export/print from the Export tab');
                return;
            }
            
            var csv = 'Safeguard,Title,Category,Implementation Status,Evidence/Notes,Risk Level,Priority\n';
            
            for (var i = 0; i < framework.controls.length; i++) {
                var c = framework.controls[i];
                var a = framework.assessments[c.id] || {};
                var row = [
                    c.id,
                    '"' + c.title.replace(/"/g, '""') + '"',
                    '"' + c.category.replace(/"/g, '""') + '"',
                    a.status || '',
                    '"' + ((a.notes || '').replace(/"/g, '""')) + '"',
                    a.risk || '',
                    a.priority || ''
                ].join(',');
                csv += row + '\n';
            }
            
            showDownloadModal('CSV Export', csv, framework.name.replace(/[^a-z0-9]/gi, '_') + '_' + new Date().toISOString().split('T')[0] + '.csv', 'text/csv');
        }

        function exportToJSON() {
            var framework = getCurrentFramework();
            if (!framework) {
                alert('‚ö†Ô∏è No Framework Open\n\nPlease follow these steps:\n\n1. Go back to the main page\n2. Create a framework (click "‚ûï Add Framework")\n3. Open the framework (click "üìÇ Open")\n4. Add controls to assess\n5. Then you can export/print from the Export tab');
                return;
            }
            
            var data = {
                exportDate: new Date().toISOString(),
                framework: framework.name,
                description: framework.description,
                assessment: framework.assessments,
                controls: framework.controls
            };
            
            var json = JSON.stringify(data, null, 2);
            
            showDownloadModal('JSON Export', json, framework.name.replace(/[^a-z0-9]/gi, '_') + '_' + new Date().toISOString().split('T')[0] + '.json', 'application/json');
        }
        
        function showDownloadModal(title, content, filename, mimeType) {
            var modal = document.createElement('div');
            modal.className = 'modal show';
            
            // Convert to base64 to handle special characters
            var base64Content = btoa(unescape(encodeURIComponent(content)));
            var dataUri = 'data:' + mimeType + ';base64,' + base64Content;
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <p style="margin-bottom: 15px; color: #2d3748; font-weight: 600;">‚úì Your export is ready!</p>
                        <p style="margin-bottom: 15px; color: #718096; font-size: 14px;">Click the download button below to save <strong>${filename}</strong></p>
                        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <a href="${dataUri}" download="${filename}" class="btn btn-primary" style="display: inline-block; text-decoration: none; padding: 12px 24px; font-size: 16px;">
                                üì• Download ${filename.endsWith('.csv') ? 'CSV' : 'JSON'}
                            </a>
                        </div>
                        <p style="color: #718096; font-size: 13px; margin-bottom: 10px;">Preview:</p>
                        <textarea readonly style="width: 100%; height: 300px; font-family: monospace; font-size: 11px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px;">${content}</textarea>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="
                            var txt = this.closest('.modal-content').querySelector('textarea');
                            txt.select();
                            document.execCommand('copy');
                            alert('‚úì Copied to clipboard!');
                        ">üìã Copy to Clipboard</button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function loadSampleData() {
            if (!confirm('Load sample CIS controls?')) return;
            
            var samples = [
                {id: '1.1', title: 'Establish Asset Inventory', category: 'Asset Management'},
                {id: '1.2', title: 'Address Unauthorized Assets', category: 'Asset Management'},
                {id: '2.1', title: 'Software Inventory', category: 'Software Assets'},
                {id: '3.1', title: 'Data Management', category: 'Data Protection'},
                {id: '6.3', title: 'MFA for External Applications', category: 'Access Management'}
            ];
            
            var framework = getCurrentFramework();
            framework.controls = framework.controls.concat(samples);
            framework.assessments['1.1'] = {status: 'implemented', risk: 'low'};
            framework.assessments['6.3'] = {status: 'not-implemented', risk: 'critical', priority: 'immediate'};
            
            saveToStorage();
            renderAssessment();
            updateDashboard();
        }

        function getCurrentFramework() {
            return frameworks.find(function(f) { return f.id === currentFrameworkId; });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
